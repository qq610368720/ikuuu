name: "iKuuu æœºåœºè‡ªåŠ¨ç­¾åˆ°ç³»ç»Ÿ"

on:
  schedule:
    - cron: "0 22 * * *"  # æ¯å¤©UTCæ—¶é—´22:00ï¼ˆåŒ—äº¬æ—¶é—´06:00ï¼‰
  workflow_dispatch:       # å…è®¸æ‰‹åŠ¨è§¦å‘

env:
  TZ: Asia/Shanghai       # å¼ºåˆ¶è®¾ç½®æ—¶åŒº
  PYTHONUNBUFFERED: 1     # å®æ—¶è¾“å‡ºæ—¥å¿—

jobs:
  automatic-checkin:
    name: ğŸ›« æ‰§è¡Œç­¾åˆ°ä»»åŠ¡
    runs-on: ubuntu-latest
    timeout-minutes: 20    # ä»»åŠ¡è¶…æ—¶æ—¶é—´
    permissions:
      contents: read       # æœ€å°æƒé™åŸåˆ™

    steps:
      # ---------------------------
      # åˆå§‹åŒ–é˜¶æ®µ
      # ---------------------------
      - name: â¬‡ï¸ æ£€å‡ºä»£ç åº“
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: false

      # ---------------------------
      # ç¯å¢ƒé…ç½®é˜¶æ®µ
      # ---------------------------
      - name: ğŸ é…ç½® Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: "3.10.12"
          cache: 'pip'               # å¯ç”¨ä¾èµ–ç¼“å­˜
          cache-dependency-path: 'requirements.txt'

      # ---------------------------
      # å‡†å¤‡é˜¶æ®µ
      # ---------------------------
      - name: â³ æ™ºèƒ½éšæœºå»¶è¿Ÿ
        if: github.event_name == 'schedule'
        run: |
          # ç”ŸæˆåŒ—äº¬æ—¶é—´06:00-07:00ä¹‹é—´çš„éšæœºå»¶è¿Ÿ
          delay=$(shuf -i 300-3600 -n 1)
          echo "éšæœºå»¶è¿Ÿï¼š${delay}ç§’"
          sleep $delay

      - name: ğŸ“¦ å®‰è£…ç³»ç»Ÿä¾èµ–
        run: |
          sudo apt-get update
          sudo apt-get install -y ca-certificates

      - name: ğŸ”§ å®‰è£…Pythonä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install requests --no-cache-dir

      # ---------------------------
      # æ ¸å¿ƒæ‰§è¡Œé˜¶æ®µ
      # ---------------------------
      - name: ğŸš€ æ‰§è¡Œç­¾åˆ°ä»»åŠ¡
        env:
          EMAIL: ${{ secrets.EMAIL }}
          PASSWD: ${{ secrets.PASSWD }}
          SCKEY: ${{ secrets.SCKEY }}
          TOKEN: ${{ secrets.TOKEN }}
        run: |
          echo "===== ä»»åŠ¡å¯åŠ¨ [$(date '+%m-%d %H:%M:%S')] ====="
          python3 -u main.py 2>&1 | tee -a runtime.log
          exit_code=${PIPESTATUS[0]}
          echo "===== ä»»åŠ¡ç»“æŸ [$(date '+%m-%d %H:%M:%S')] ====="
          exit $exit_code

      # ---------------------------
      # åå¤„ç†é˜¶æ®µ
      # ---------------------------
      - name: ğŸ“¤ ä¸Šä¼ æ‰§è¡Œæ—¥å¿—
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: checkin-logs
          path: |
            runtime.log
            main.log

      - name: ğŸ§¹ æ¸…ç†ä¸´æ—¶æ–‡ä»¶
        if: always()
        run: rm -f runtime.log

      # ---------------------------
      # é€šçŸ¥é˜¶æ®µ
      # ---------------------------
      - name: ğŸ“¢ å‘é€æœ€ç»ˆé€šçŸ¥
        if: always()
        env: 
          SCKEY: ${{ secrets.SCKEY }}
          TOKEN: ${{ secrets.TOKEN }}
        run: |
          # è§£æä»»åŠ¡çŠ¶æ€
          status="${{ job.status }}"
          timestamp=$(date '+%m-%d %H:%M:%S')

          # æ„å»ºé€šçŸ¥å†…å®¹
          if [ "$status" = "success" ]; then
            title="âœ… ç­¾åˆ°æˆåŠŸ - $timestamp"
            status_msg="æ‰€æœ‰æµç¨‹å·²å®Œæˆ"
          else
            title="âŒ ç­¾åˆ°å¤±è´¥ - $timestamp"
            status_msg="æ‰§è¡Œè¿‡ç¨‹ä¸­é‡åˆ°é”™è¯¯"
          fi

          # Serveré…±æ¨é€
          if [ -n "$SCKEY" ] && [ "$SCKEY" != "1" ]; then
            curl -s "https://sctapi.ftqq.com/$SCKEY.send?title=$title&descr=$status_msg%0AæŸ¥çœ‹æ—¥å¿—è·å–è¯¦ç»†ä¿¡æ¯"
          fi

          # PushPlusæ¨é€
          if [ -n "$TOKEN" ] && [ "$TOKEN" != "1" ]; then
            curl -s -X POST "http://www.pushplus.plus/send" \
              -H "Content-Type: application/json" \
              -d "{\"token\":\"$TOKEN\",\"title\":\"$title\",\"content\":\"$status_msg\",\"template\":\"txt\"}"
          fi
