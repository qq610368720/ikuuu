name: "iKuuu 机场自动签到系统"

on:
  schedule:
    - cron: "0 22 * * *"  # 每天UTC时间22:00（北京时间06:00）
  workflow_dispatch:       # 允许手动触发

env:
  TZ: Asia/Shanghai       # 强制设置时区
  PYTHONUNBUFFERED: 1     # 实时输出日志

jobs:
  automatic-checkin:
    name: 🛫 执行签到任务
    runs-on: ubuntu-latest
    timeout-minutes: 20    # 任务超时时间
    permissions:
      contents: read       # 最小权限原则

    steps:
      # ---------------------------
      # 初始化阶段
      # ---------------------------
      - name: ⬇️ 检出代码库
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: false

      # ---------------------------
      # 环境配置阶段
      # ---------------------------
      - name: 🐍 配置 Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: "3.10.12"
          cache: 'pip'               # 启用依赖缓存
          cache-dependency-path: 'requirements.txt'

      # ---------------------------
      # 准备阶段
      # ---------------------------
      - name: ⏳ 智能随机延迟
        if: github.event_name == 'schedule'
        run: |
          # 生成北京时间06:00-07:00之间的随机延迟
          delay=$(shuf -i 300-3600 -n 1)
          echo "随机延迟：${delay}秒"
          sleep $delay

      - name: 📦 安装系统依赖
        run: |
          sudo apt-get update
          sudo apt-get install -y ca-certificates

      - name: 🔧 安装Python依赖
        run: |
          python -m pip install --upgrade pip
          pip install requests --no-cache-dir

      # ---------------------------
      # 核心执行阶段
      # ---------------------------
      - name: 🚀 执行签到任务
        env:
          EMAIL: ${{ secrets.EMAIL }}
          PASSWD: ${{ secrets.PASSWD }}
          SCKEY: ${{ secrets.SCKEY }}
          TOKEN: ${{ secrets.TOKEN }}
        run: |
          echo "===== 任务启动 [$(date '+%m-%d %H:%M:%S')] ====="
          python3 -u main.py 2>&1 | tee -a runtime.log
          exit_code=${PIPESTATUS[0]}
          echo "===== 任务结束 [$(date '+%m-%d %H:%M:%S')] ====="
          exit $exit_code

      # ---------------------------
      # 后处理阶段
      # ---------------------------
      - name: 📤 上传执行日志
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: checkin-logs
          path: |
            runtime.log
            main.log

      - name: 🧹 清理临时文件
        if: always()
        run: rm -f runtime.log

      # ---------------------------
      # 通知阶段
      # ---------------------------
      - name: 📢 发送最终通知
        if: always()
        env: 
          SCKEY: ${{ secrets.SCKEY }}
          TOKEN: ${{ secrets.TOKEN }}
        run: |
          # 解析任务状态
          status="${{ job.status }}"
          timestamp=$(date '+%m-%d %H:%M:%S')

          # 构建通知内容
          if [ "$status" = "success" ]; then
            title="✅ 签到成功 - $timestamp"
            status_msg="所有流程已完成"
          else
            title="❌ 签到失败 - $timestamp"
            status_msg="执行过程中遇到错误"
          fi

          # Server酱推送
          if [ -n "$SCKEY" ] && [ "$SCKEY" != "1" ]; then
            curl -s "https://sctapi.ftqq.com/$SCKEY.send?title=$title&descr=$status_msg%0A查看日志获取详细信息"
          fi

          # PushPlus推送
          if [ -n "$TOKEN" ] && [ "$TOKEN" != "1" ]; then
            curl -s -X POST "http://www.pushplus.plus/send" \
              -H "Content-Type: application/json" \
              -d "{\"token\":\"$TOKEN\",\"title\":\"$title\",\"content\":\"$status_msg\",\"template\":\"txt\"}"
          fi
