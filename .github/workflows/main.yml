- name: 📢 推送通知
  if: always()
  env:
    SCKEY: ${{ secrets.SCKEY }}
    TOKEN: ${{ secrets.TOKEN }}
  shell: bash
  run: |
    # 安装必要工具（jq）
    sudo apt-get -qq update && sudo apt-get -qq install jq

    # 获取任务状态
    status="${{ job.status }}"
    timestamp=$(date '+%m-%d %H:%M:%S')

    # Server酱推送
    if [[ -n "$SCKEY" && "$SCKEY" != "1" ]]; then
      echo "→ 发送Server酱通知"
      encoded_title="$(echo "签到${status}" | jq -Rr @uri)"
      encoded_descr="$(echo "时间：${timestamp}" | jq -Rr @uri)"
      
      curl_response=$(curl -s -o /dev/null -w "%{http_code}" \
        -G "https://sctapi.ftqq.com/$SCKEY.send" \
        --data-urlencode "title=$encoded_title" \
        --data-urlencode "descr=$encoded_descr")
      
      echo "Server酱返回状态码：$curl_response"
    fi

    # PushPlus推送
    if [[ -n "$TOKEN" && "$TOKEN" != "1" ]]; then
      echo "→ 发送PushPlus通知"
      json_payload=$(jq -n \
        --arg token "$TOKEN" \
        --arg title "签到${status}" \
        --arg content "时间：${timestamp}" \
        '{token: $token, title: $title, content: $content}')
      
      curl_response=$(curl -s -o /dev/null -w "%{http_code}" \
        -X POST "http://www.pushplus.plus/send" \
        -H "Content-Type: application/json" \
        -d "$json_payload")
      
      echo "PushPlus返回状态码：$curl_response"
    fi
