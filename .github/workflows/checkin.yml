name: "iKuuu 机场自动签到"

jobs:
  checkin:
    steps:
      # ...其他步骤保持不变...

      - name: 📢 推送状态通知
        if: always()
        env:
          SCKEY: ${{ secrets.SCKEY }}
          TOKEN: ${{ secrets.TOKEN }}
        shell: bash
        run: |
          set -euo pipefail
          sudo apt-get -qq update && sudo apt-get -qq install -y jq
          
          status="${{ job.status }}"
          timestamp=$(date '+%Y-%m-%d %H:%M:%S')

          # Server酱推送
          if [[ -n "$SCKEY" && "$SCKEY" != "1" ]]; then
            encoded_title=$(jq -nr --arg status "$status" '签到\($status)|@uri')
            encoded_descr=$(jq -nr --arg ts "$timestamp" '执行时间：\($ts)|@uri')
            
            curl -s -G "https://sctapi.ftqq.com/$SCKEY.send" \
              --data-urlencode "title=$encoded_title" \
              --data-urlencode "descr=$encoded_descr" \
              --fail-with-body
          fi

          # PushPlus推送
          if [[ -n "$TOKEN" && "$TOKEN" != "1" ]]; then
            json_data=$(jq -n \
              --arg token "$TOKEN" \
              --arg title "签到${status}" \
              --arg content "执行时间：${timestamp}" \
              '{token: $token, title: $title, content: $content}')
            
            curl -s -X POST "http://www.pushplus.plus/send" \
              -H "Content-Type: application/json" \
              -d "$json_data" \
              --fail-with-body
          fi
